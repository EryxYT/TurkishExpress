<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Turkish Express</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: "Times New Roman", serif;
    }

    /* Temalar i√ßin data-theme attribute'u ile renkler */

    body[data-theme="dark"] {
      background: #000;
      color: white;
    }
    body[data-theme="light"] {
      background: #fff;
      color: black;
    }

    body[data-theme="dark"] .container {
      background: #111;
    }
    body[data-theme="light"] .container {
      background: #f5f5f5;
    }

    body[data-theme="dark"] input,
    body[data-theme="dark"] textarea {
      background: #222;
      color: white;
      border: none;
    }
    body[data-theme="light"] input,
    body[data-theme="light"] textarea {
      background: #eee;
      color: black;
      border: 1px solid #ccc;
    }

    body[data-theme="dark"] button {
      background: #FFD700;
      color: black;
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    body[data-theme="light"] button {
      background: #ffa500;
      color: black;
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    body[data-theme="dark"] button:hover:not(:disabled) {
      background: #e6c200;
    }
    body[data-theme="light"] button:hover:not(:disabled) {
      background: #cc8400;
    }

    body[data-theme="dark"] button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    body[data-theme="light"] button:disabled {
      background: #bbb;
      cursor: not-allowed;
    }

    body[data-theme="dark"] h1.logo,
    body[data-theme="dark"] .subtitle,
    body[data-theme="dark"] #status,
    body[data-theme="dark"] #cardInfo,
    body[data-theme="dark"] .morning-mode-toggle,
    body[data-theme="dark"] .user-info,
    body[data-theme="dark"] .info-small,
    body[data-theme="dark"] footer {
      color: #FFD700;
      user-select: none;
    }

    body[data-theme="light"] h1.logo,
    body[data-theme="light"] .subtitle,
    body[data-theme="light"] #status,
    body[data-theme="light"] #cardInfo,
    body[data-theme="light"] .morning-mode-toggle,
    body[data-theme="light"] .user-info,
    body[data-theme="light"] .info-small,
    body[data-theme="light"] footer {
      color: #b8860b;
      user-select: none;
    }

    body[data-theme="dark"] ul {
      border-top: 1px solid #444;
      color: white;
    }
    body[data-theme="light"] ul {
      border-top: 1px solid #ccc;
      color: black;
    }

    /* Diƒüer stiller */
    body {
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: background 0.4s ease, color 0.4s ease;
    }

    h1.logo {
      font-size: 2.8rem;
      text-align: center;
      margin: 0 0 4px;
    }

    .subtitle {
      font-size: 1rem;
      text-align: center;
      margin-bottom: 20px;
    }

    input, button, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      font-size: 1rem;
      transition: background 0.3s ease, color 0.3s ease, border 0.3s ease;
    }

    .container {
      max-width: 420px;
      margin: auto;
      padding: 25px 30px;
      border-radius: 12px;
      flex-grow: 1;
      transition: background 0.4s ease;
    }

    #dashboard {
      display: none;
    }

    ul {
      list-style: none;
      padding-left: 0;
      font-size: 14px;
      max-height: 160px;
      overflow-y: auto;
      margin-top: 10px;
      padding-top: 8px;
      transition: color 0.4s ease, border-color 0.4s ease;
    }

    ul li {
      margin-bottom: 6px;
    }

    footer {
      text-align: center;
      font-size: 12px;
      padding: 18px 0 6px;
      user-select: none;
      transition: color 0.4s ease;
    }

    #status, #cardInfo {
      text-align: center;
      margin-top: 12px;
      font-style: italic;
      font-size: 1.1rem;
    }

    #cardInfo {
      font-weight: 700;
      font-style: normal;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .morning-mode-toggle {
      cursor: pointer;
      user-select: none;
      border-radius: 6px;
      padding: 2px 6px;
      font-size: 0.9rem;
      border: 1px solid;
      transition: background 0.3s ease, color 0.3s ease;
      margin-left: auto;
    }
    body[data-theme="dark"] .morning-mode-toggle {
      background: #222;
      color: #FFD700;
      border-color: #FFD700;
    }
    body[data-theme="dark"] .morning-mode-toggle.active {
      background: #FFD700;
      color: black;
    }
    body[data-theme="light"] .morning-mode-toggle {
      background: #eee;
      color: #b8860b;
      border-color: #b8860b;
    }
    body[data-theme="light"] .morning-mode-toggle.active {
      background: #b8860b;
      color: white;
    }

    .danger-button {
      background: #b22222;
      color: white;
      font-weight: 700;
      margin-top: 15px;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .danger-button:hover {
      background: #8b1a1a;
    }

    .info-small {
      font-size: 0.85rem;
      margin-top: -6px;
      margin-bottom: 12px;
      user-select: none;
    }

    @media (max-width: 480px) {
      .container {
        width: 90%;
        padding: 20px;
      }
    }
  </style>
</head>
<body data-theme="dark">
  <div class="container">
    <h1 class="logo">Turkish Express</h1>
    <div class="subtitle"> TBL Resmi Sponsoru</div>

    <div id="register">
      <h3>Kart Talep Et</h3>
      <input id="reg-name" placeholder="ƒ∞sim" autocomplete="off" />
      <input id="reg-pin" placeholder="4 Haneli ≈ûifre" maxlength="4" autocomplete="off" />
      <button id="requestCardBtn">Kart Olu≈ütur</button>
      <div id="status" style="display:none;">Sayƒ±lar Bulunuyor...</div>
      <div id="cardInfo" style="display:none;"></div>
    </div>

    <div id="login" style="margin-top: 30px;">
      <h3>Giri≈ü Yap</h3>
      <input id="login-card" placeholder="Kart Numarasƒ±" autocomplete="off" />
      <input id="login-pin" placeholder="≈ûifre" maxlength="4" autocomplete="off" />
      <button id="loginBtn">Giri≈ü</button>
      <p id="login-result" style="color:#f33;"></p>
    </div>

    <div id="dashboard">
      <div class="user-info">
        üë§ <span id="user-name"></span> <span id="morning-mode-status" title="Tema"></span>
        <button id="morningModeToggle" class="morning-mode-toggle" title="Tema deƒüi≈ütir">üåô Karanlƒ±k Mod</button>
      </div>
      <p>üí∞ Bakiye: <span id="user-balance"></span>‚Ç∫</p>

      <h4>üí∏ Para G√∂nder</h4>
      <input id="to-username" placeholder="Alƒ±cƒ±nƒ±n Kullanƒ±cƒ± Adƒ±" autocomplete="off" />
      <input id="send-amount" placeholder="Tutar" type="number" min="1" />
      <textarea id="send-note" placeholder="Not bƒ±rakabilirsiniz (isteƒüe baƒülƒ±)" rows="2" style="width:100%; margin: 8px 0; border-radius:6px; padding:8px;"></textarea>
      <button id="sendMoneyBtn">G√∂nder</button>
      <p id="send-result" style="color:#f33;"></p>

      <h4>üìú ƒ∞≈ülem Ge√ßmi≈üi</h4>
      <ul id="history-list"></ul>

      <hr style="margin: 20px 0; border-color: #444;" />

      <h4>‚öôÔ∏è Hesap Ayarlarƒ±</h4>
      <input id="new-name" placeholder="Yeni ƒ∞sim (en fazla 2 kere deƒüi≈üebilir)" autocomplete="off" />
      <div class="info-small" id="name-change-info"></div>

      <input id="new-pin" placeholder="Yeni 4 Haneli ≈ûifre" maxlength="4" autocomplete="off" />
      <input id="confirm-pin" placeholder="Yeni ≈ûifre Onayƒ±" maxlength="4" autocomplete="off" />
      <button id="updateAccountBtn">Hesap Bilgilerini G√ºncelle</button>
      <p id="update-result" style="color:#f33;"></p>

      <button id="deleteAccountBtn" class="danger-button">‚ö†Ô∏è Hesabƒ± Sil</button>
      <p id="delete-result" style="color:#f33;"></p>
    </div>
  </div>

  <footer>¬© 2025 Turkish Express ‚Äì T√ºm Haklarƒ± Saklƒ±dƒ±r.</footer>

  <script>
    const requestCardBtn = document.getElementById("requestCardBtn");
    const loginBtn = document.getElementById("loginBtn");
    const sendMoneyBtn = document.getElementById("sendMoneyBtn");
    const updateAccountBtn = document.getElementById("updateAccountBtn");
    const deleteAccountBtn = document.getElementById("deleteAccountBtn");
    const morningModeToggle = document.getElementById("morningModeToggle");

    const statusDiv = document.getElementById("status");
    const cardInfoDiv = document.getElementById("cardInfo");
    const loginResult = document.getElementById("login-result");
    const sendResult = document.getElementById("send-result");
    const updateResult = document.getElementById("update-result");
    const deleteResult = document.getElementById("delete-result");
    const nameChangeInfo = document.getElementById("name-change-info");
    const morningModeStatus = document.getElementById("morning-mode-status");

    let currentCard = "";
    let currentUsername = "";
    let nameChangeCount = 0;
    let currentTheme = "dark"; // default tema

    // Tema ayarlarƒ±nƒ± body attribute ile uygula ve butonu g√ºncelle
    function setTheme(theme) {
      currentTheme = theme;
      document.body.setAttribute("data-theme", theme);
      updateMorningModeToggle();
      // Eƒüer backend'e kaydetmek istersen buraya fetch ekleyebilirsin
      /*
      fetch("/api/set-theme", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ cardNumber: currentCard, theme }),
      });
      */
    }

    function updateMorningModeToggle() {
      if (currentTheme === "dark") {
        morningModeToggle.textContent = "üåô Karanlƒ±k Mod";
        morningModeToggle.classList.remove("active");
        morningModeToggle.title = "Tema deƒüi≈ütir: A√ßƒ±k Mod";
      } else {
        morningModeToggle.textContent = "‚òÄÔ∏è A√ßƒ±k Mod";
        morningModeToggle.classList.add("active");
        morningModeToggle.title = "Tema deƒüi≈ütir: Karanlƒ±k Mod";
      }
    }

    // Kart talep et - animasyon ve kart numarasƒ± g√∂sterimi
    requestCardBtn.addEventListener("click", () => {
      const name = document.getElementById("reg-name").value.trim();
      const pin = document.getElementById("reg-pin").value.trim();

      if (!name || pin.length !== 4) {
        alert("L√ºtfen isim ve 4 haneli ≈üifre girin.");
        return;
      }

      requestCardBtn.disabled = true;
      statusDiv.style.display = "block";
      cardInfoDiv.style.display = "none";
      cardInfoDiv.textContent = "";
      let steps = [
        "Sayƒ±lar Bulunuyor...",
        "Veritabanƒ±yla E≈üle≈üiyor...",
        "Kullanƒ±cƒ± Olu≈üturuluyor..."
      ];
      let stepIndex = 0;

      const interval = setInterval(() => {
        statusDiv.textContent = steps[stepIndex];
        stepIndex++;
        if (stepIndex >= steps.length) {
          clearInterval(interval);
          fetch("/api/request-card", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, pin })
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                statusDiv.style.display = "none";
                cardInfoDiv.style.display = "block";
                cardInfoDiv.textContent = `üéâ Kart Numaran: ${data.cardNumber}`;
              } else {
                statusDiv.style.display = "none";
                cardInfoDiv.style.display = "block";
                cardInfoDiv.textContent = `‚ùå ${data.error}`;
              }
              requestCardBtn.disabled = false;
            })
            .catch(() => {
              statusDiv.style.display = "none";
              cardInfoDiv.style.display = "block";
              cardInfoDiv.textContent = "‚ùå Sunucu hatasƒ±.";
              requestCardBtn.disabled = false;
            });
        }
      }, 1700);
    });

    // Giri≈ü
    loginBtn.addEventListener("click", () => {
      const cardNumber = document.getElementById("login-card").value.trim();
      const pin = document.getElementById("login-pin").value.trim();
      if (!cardNumber || pin.length !== 4) {
        loginResult.textContent = "Kart numarasƒ± ve 4 haneli ≈üifre gerekli.";
        return;
      }
      loginResult.textContent = "";

      fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cardNumber, pin })
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            if (data.admin) {
              window.location.href = "/admin";
              return;
            }
            currentCard = data.cardNumber;
            currentUsername = data.name;
            nameChangeCount = data.nameChangeCount || 0;
            // Eƒüer backendden tema bilgisi gelirse onu uygula, yoksa default
            setTheme(data.theme || "dark");

            document.getElementById("register").style.display = "none";
            document.getElementById("login").style.display = "none";
            document.getElementById("dashboard").style.display = "block";
            updateUserInfoDisplay();
            document.getElementById("user-balance").textContent = data.balance;
            renderHistory(data.history);

            updateNameChangeUI();
          } else {
            loginResult.textContent = data.error || "Hata olu≈ütu.";
          }
        })
        .catch(() => {
          loginResult.textContent = "Sunucu ile baƒülantƒ± kurulamadƒ±.";
        });
    });

    function updateUserInfoDisplay() {
      document.getElementById("user-name").textContent = currentUsername;
    }

    function updateNameChangeUI() {
      if(nameChangeCount >= 2){
        document.getElementById("new-name").disabled = true;
        nameChangeInfo.textContent = "ƒ∞sim deƒüi≈üikliƒüi hakkƒ±nƒ±zƒ± kullandƒ±nƒ±z.";
      } else {
        document.getElementById("new-name").disabled = false;
        nameChangeInfo.textContent = `ƒ∞sim deƒüi≈ütirme hakkƒ±nƒ±z: ${2 - nameChangeCount}`;
      }
    }

    // Para g√∂nderme
    sendMoneyBtn.addEventListener("click", () => {
      const toUser = document.getElementById("to-username").value.trim();
      const amount = Number(document.getElementById("send-amount").value);
      const note = document.getElementById("send-note").value.trim();

      if (!toUser || isNaN(amount) || amount < 1) {
        sendResult.textContent = "Ge√ßerli alƒ±cƒ± ve tutar giriniz.";
        return;
      }
      sendResult.textContent = "";

      sendMoneyBtn.disabled = true;

      fetch("/api/send-money", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          fromCard: currentCard,
          toUser,
          amount,
          note,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            sendResult.style.color = "green";
            sendResult.textContent = "Para ba≈üarƒ±yla g√∂nderildi.";
            document.getElementById("user-balance").textContent = data.newBalance;
            renderHistory(data.history);
          } else {
            sendResult.style.color = "#f33";
            sendResult.textContent = data.error || "G√∂nderme ba≈üarƒ±sƒ±z.";
          }
          sendMoneyBtn.disabled = false;
        })
        .catch(() => {
          sendResult.style.color = "#f33";
          sendResult.textContent = "Sunucu hatasƒ±.";
          sendMoneyBtn.disabled = false;
        });
    });

    // Hesap g√ºncelleme
    updateAccountBtn.addEventListener("click", () => {
      const newName = document.getElementById("new-name").value.trim();
      const newPin = document.getElementById("new-pin").value.trim();
      const confirmPin = document.getElementById("confirm-pin").value.trim();

      updateResult.textContent = "";

      if (newName && nameChangeCount >= 2) {
        updateResult.textContent = "ƒ∞sim deƒüi≈ütirme hakkƒ±nƒ±z kalmadƒ±.";
        return;
      }
      if (newPin && newPin.length !== 4) {
        updateResult.textContent = "Yeni ≈üifre 4 haneli olmalƒ±.";
        return;
      }
      if (newPin && newPin !== confirmPin) {
        updateResult.textContent = "≈ûifreler uyu≈ümuyor.";
        return;
      }

      const bodyData = { cardNumber: currentCard };
      if (newName) bodyData.newName = newName;
      if (newPin) bodyData.newPin = newPin;

      updateAccountBtn.disabled = true;

      fetch("/api/update-account", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(bodyData),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            updateResult.style.color = "green";
            updateResult.textContent = "Hesap ba≈üarƒ±yla g√ºncellendi.";
            if (newName) {
              currentUsername = newName;
              nameChangeCount++;
              updateUserInfoDisplay();
              updateNameChangeUI();
            }
          } else {
            updateResult.style.color = "#f33";
            updateResult.textContent = data.error || "G√ºncelleme ba≈üarƒ±sƒ±z.";
          }
          updateAccountBtn.disabled = false;
        })
        .catch(() => {
          updateResult.style.color = "#f33";
          updateResult.textContent = "Sunucu hatasƒ±.";
          updateAccountBtn.disabled = false;
        });
    });

    // Hesap silme
    deleteAccountBtn.addEventListener("click", () => {
      if (!confirm("Hesabƒ±nƒ±zƒ± silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz.")) return;

      deleteResult.textContent = "";
      deleteAccountBtn.disabled = true;

      fetch("/api/delete-account", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cardNumber: currentCard }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            alert("Hesabƒ±nƒ±z silindi. Sayfa yenileniyor.");
            location.reload();
          } else {
            deleteResult.textContent = data.error || "Silme i≈ülemi ba≈üarƒ±sƒ±z.";
          }
          deleteAccountBtn.disabled = false;
        })
        .catch(() => {
          deleteResult.textContent = "Sunucu hatasƒ±.";
          deleteAccountBtn.disabled = false;
        });
    });

    // ƒ∞≈ülem ge√ßmi≈üini listele
    function renderHistory(history) {
      const historyList = document.getElementById("history-list");
      historyList.innerHTML = "";
      if (!history || history.length === 0) {
        historyList.innerHTML = "<li>ƒ∞≈ülem ge√ßmi≈üi bo≈ü.</li>";
        return;
      }
      history.forEach((item) => {
        const li = document.createElement("li");
        li.textContent = `${item.date} - ${item.description} - ${item.amount}‚Ç∫`;
        historyList.appendChild(li);
      });
    }

    // Tema deƒüi≈ütirme butonu
    morningModeToggle.addEventListener("click", () => {
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      setTheme(newTheme);
    });

  </script>
</body>
</html>
